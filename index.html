<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="theme-color" content="#0b0d12"/>
  <title>Lux Gold Dashboard</title>

  <link rel="manifest" href="./manifest.json"/>
  <link rel="icon" href="./icons/icon-192.png"/>
  <link rel="apple-touch-icon" href="./icons/icon-192.png"/>

  <link rel="preconnect" href="https://cdn.jsdelivr.net"/>
  <link rel="stylesheet" href="./style.css"/>

  <!-- Chart.js + zoom plugin (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js" defer></script>

  <!-- Supabase JS (optional; only used if you paste an anon key in Settings) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js" defer></script>

  <script src="./logic.js" defer></script>
</head>

<body>
  <div class="bg-aurora" aria-hidden="true"></div>

  <header class="topbar">
    <div class="brand">
      <img class="brand__icon" src="./icons/icon-192.png" alt="LuxGold"/>
      <div class="brand__text">
        <div class="brand__title">Lux Gold</div>
        <div class="brand__sub">Live XAU • IQD Tools • History</div>
      </div>
    </div>

    <div class="topbar__right">
      <div class="chip chip--clock">
        <div class="chip__label">Local time</div>
        <div class="chip__value" id="clockLocal">—</div>
      </div>

      <div class="chip chip--update">
        <div class="chip__label">Last price change</div>
        <div class="chip__value" id="lastUpdated">—</div>
      </div>

      <button class="chip chip--settings" id="openSettings" type="button" aria-label="Settings">
        <span class="chip__label">Settings</span>
        <span class="chip__value">⚙</span>
      </button>

      <div class="conn" id="conn">
        <div class="conn__signal" aria-hidden="true">
          <span></span><span></span><span></span><span></span>
        </div>
        <div class="conn__text">
          <div class="conn__status" id="connStatus">Checking…</div>
          <div class="conn__meta" id="connMeta">—</div>
        </div>
      </div>
    </div>
  </header>

  <main class="layout">
    <!-- LEFT (70%) -->
    <section class="col col--primary">
      <div class="grid2">
        <!-- Live market -->
        <article class="card card--hero">
          <div class="card__head">
            <div>
              <div class="kicker">Market</div>
              <h2 class="title">Live Gold (XAU) — Per Ounce</h2>
            </div>
            <div class="pill" id="feedPill">
              <span class="dot"></span>
              <span class="pill__text">Live feed</span>
            </div>
          </div>

          <div class="hero">
            <div class="hero__price">
              <div class="label">Spot price</div>
              <div class="value" id="liveOunce">—</div>
              <div class="subrow">
                <span class="delta" id="liveDelta">—</span>
                <span class="meta" id="liveMetrics">—</span>
              </div>
            </div>

            <div class="hero__controls">
              <div class="field">
                <label for="usdToIqd">USD → IQD rate (optional)</label>
                <input id="usdToIqd" inputmode="decimal" placeholder="Example: 1500" autocomplete="off"/>
                <div class="hint">Leave empty to keep USD ($). Fill to convert everything to IQD.</div>
              </div>

              <div class="row2">
                <div class="field">
                  <label for="unitLive">Unit</label>
                  <select id="unitLive">
                    <option value="mithqal">Mithqal (5g)</option>
                    <option value="gram">Gram (1g)</option>
                  </select>
                </div>
                <div class="field">
                  <label for="karatLive">Karat</label>
                  <select id="karatLive">
                    <option value="24">24k</option>
                    <option value="22">22k</option>
                    <option value="21" selected>21k</option>
                    <option value="18">18k</option>
                  </select>
                </div>
              </div>

              <div class="field">
                <div class="sliderHead">
                  <label for="marginLive">Local margin (IQD only)</label>
                  <span class="sliderValue" id="marginLiveLabel">—</span>
                </div>
                <input id="marginLive" type="range" min="0" max="70000" step="1000" value="0"/>
                <div class="hint">Margin is added per mithqal. For grams, margin is divided by 5.</div>
              </div>

              <div class="hero__result">
                <div class="label">Selected price</div>
                <div class="value" id="selectedLive">—</div>
                <div class="subrow">
                  <span class="delta" id="selectedLiveDelta">—</span>
                  <span class="meta" id="selectedLiveMeta">—</span>
                </div>
              </div>
            </div>
          </div>
        </article>

        <!-- Karats list -->
        <article class="card">
          <div class="card__head">
            <div>
              <div class="kicker">Karats</div>
              <h3 class="title">Prices List (auto-sync with live)</h3>
            </div>
            <div class="miniNote" id="currencyNote">USD mode</div>
          </div>

          <div class="karats" id="karatsList">
            <!-- injected -->
          </div>
        </article>
      </div>

      <!-- Chart -->
      <article class="card card--chart">
        <div class="card__head">
          <div>
            <div class="kicker">History</div>
            <h3 class="title">Gold Price Chart</h3>
            <div class="subtitle">Scroll wheel = zoom • Drag = pan • Hover/touch = crosshair</div>
          </div>

          <div class="tf">
            <button class="tf__btn is-active" data-tf="24h" type="button">24h</button>
            <button class="tf__btn" data-tf="7d" type="button">7d</button>
            <button class="tf__btn" data-tf="1m" type="button">Months</button>
            <button class="tf__btn" data-tf="1y" type="button">Years</button>
          </div>
        </div>

        <div class="chartWrap">
          <canvas id="chartCanvas" height="170"></canvas>
          <div class="chartHint" id="chartHint">Loading history…</div>
        </div>

        <div class="chartFoot">
          <div class="chartFoot__left">
            <div class="stat"><span class="stat__k">24h High</span><span class="stat__v" id="statHigh">—</span></div>
            <div class="stat"><span class="stat__k">24h Low</span><span class="stat__v" id="statLow">—</span></div>
            <div class="stat"><span class="stat__k">Volatility</span><span class="stat__v" id="statVol">—</span></div>
          </div>
          <div class="chartFoot__right">
            <button class="btn btn--ghost" id="exportHistory" type="button">Export history</button>
            <button class="btn" id="clearLocalHistory" type="button">Clear local</button>
          </div>
        </div>
      </article>
    </section>

    <!-- RIGHT (30%) -->
    <aside class="col col--secondary">
      <!-- Expectation -->
      <article class="card">
        <div class="card__head">
          <div>
            <div class="kicker">Expectation</div>
            <h3 class="title">What-if Calculator</h3>
          </div>
        </div>

        <div class="stack">
          <div class="field">
            <label for="expOunce">Expected ounce price</label>
            <input id="expOunce" inputmode="decimal" placeholder="Example: 2400"/>
          </div>
          <div class="field">
            <label for="expUsdToIqd">USD → IQD rate</label>
            <input id="expUsdToIqd" inputmode="decimal" placeholder="Example: 1500"/>
          </div>

          <div class="row2">
            <div class="field">
              <label for="expUnit">Unit</label>
              <select id="expUnit">
                <option value="mithqal" selected>Mithqal (5g)</option>
                <option value="gram">Gram (1g)</option>
              </select>
            </div>
            <div class="field">
              <label for="expKarat">Karat</label>
              <select id="expKarat">
                <option value="21" selected>21k</option>
                <option value="22">22k</option>
                <option value="24">24k</option>
                <option value="18">18k</option>
              </select>
            </div>
          </div>

          <div class="field">
            <div class="sliderHead">
              <label for="expMargin">Margin (IQD)</label>
              <span class="sliderValue" id="expMarginLabel">—</span>
            </div>
            <input id="expMargin" type="range" min="0" max="70000" step="1000" value="0"/>
          </div>

          <div class="resultBox">
            <div class="label">Result</div>
            <div class="value" id="expResult">—</div>
            <div class="hint" id="expHint">Tip: numbers update instantly while you type.</div>
          </div>
        </div>
      </article>

      <!-- Margin solver -->
      <article class="card">
        <div class="card__head">
          <div>
            <div class="kicker">Tax / Margin Solve</div>
            <h3 class="title">Find the hidden margin</h3>
          </div>
        </div>

        <div class="stack">
          <div class="field">
            <label for="solOunce">Local ounce price (USD)</label>
            <input id="solOunce" inputmode="decimal" placeholder="Example: 2350"/>
          </div>
          <div class="field">
            <label for="solUsdToIqd">USD → IQD rate</label>
            <input id="solUsdToIqd" inputmode="decimal" placeholder="Example: 1500"/>
          </div>
          <div class="field">
            <label for="solLocal21">Local 21k price (per mithqal, IQD)</label>
            <input id="solLocal21" inputmode="decimal" placeholder="Example: 530000"/>
          </div>

          <div class="resultBox">
            <div class="label">Margin result</div>
            <div class="value" id="solResult">—</div>
            <div class="hint">Auto-applies to live & expectation sliders once it becomes valid.</div>
          </div>
        </div>
      </article>

      <!-- Calculator -->
      <article class="card card--calc">
        <div class="card__head">
          <div>
            <div class="kicker">Tools</div>
            <h3 class="title">Advanced Calculator</h3>
            <div class="subtitle">Samsung-style layout • ÷ symbol • History</div>
          </div>
          <button class="btn btn--ghost" id="toggleCalcHistory" type="button">History</button>
        </div>

        <div class="calc">
          <div class="calc__display">
            <div class="calc__expr" id="calcExpr"> </div>
            <div class="calc__main" id="calcMain">0</div>
          </div>

          <div class="calc__grid" id="calcKeys" aria-label="Calculator keys">
            <!-- injected -->
          </div>

          <div class="calc__history" id="calcHistory" hidden>
            <div class="calc__historyHead">
              <span>History</span>
              <button class="btn btn--ghost btn--tiny" id="clearCalcHistory" type="button">Clear</button>
            </div>
            <div class="calc__historyList" id="calcHistoryList"></div>
          </div>
        </div>
      </article>

      <footer class="footer">
        <div class="footer__note">
          Works offline (cached). For full Supabase history sync, open Settings and paste your Supabase anon key.
        </div>
      </footer>
    </aside>
  </main>

  <!-- Settings modal -->
  <div class="modal" id="settingsModal" hidden>
    <div class="modal__backdrop" data-close="1"></div>
    <div class="modal__panel" role="dialog" aria-modal="true" aria-label="Settings">
      <div class="modal__head">
        <div>
          <div class="kicker">Settings</div>
          <div class="title">Supabase + Preferences</div>
        </div>
        <button class="btn btn--ghost" id="closeSettings" type="button">Close</button>
      </div>

      <div class="modal__body">
        <div class="field">
          <label>Supabase Project URL (fixed)</label>
          <input value="https://ypdpopphenmbtivdtlip.supabase.co" disabled/>
        </div>

        <div class="field">
          <label for="sbAnon">Supabase anon key (optional)</label>
          <input id="sbAnon" placeholder="Paste anon public key here (kept in this browser)"/>
          <div class="hint">If you leave this empty, the chart still works using local history only.</div>
        </div>

        <div class="row2">
          <button class="btn" id="saveSettings" type="button">Save</button>
          <button class="btn btn--ghost" id="testSupabase" type="button">Test sync</button>
        </div>

        <div class="miniLog" id="settingsLog">—</div>
      </div>

      <div class="modal__foot">
        <div class="hint">
          Android install: open this page in Chrome → menu → <b>Add to Home screen</b>. (That is the “APK-like” install for a web app.)
        </div>
      </div>
    </div>
  </div>
</body>
</html>